@rendermode InteractiveServer
@inject IPermissionService PermissionService

<div class="relative">
    <button type="button" @onclick="ToggleDropdown" @onclick:stopPropagation class="flex items-center space-x-1 text-gray-600 hover:text-gray-900 focus:outline-none">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold shadow-md">
            @GetInitials(UserName)
        </div>
        <svg class="w-4 h-4 transition-transform @(isDropdownOpen ? "rotate-180" : "")" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>
    
    @if (isDropdownOpen)
    {
        <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 border border-gray-200" @onclick:stopPropagation>
            <div class="px-4 py-2 border-b border-gray-100">
                <div class="text-sm font-medium text-gray-900">@UserName</div>
                <div class="text-xs text-gray-500">@userRole</div>
            </div>
            <a href="/logout" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                <svg class="w-4 h-4 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                Sign Out
            </a>
        </div>
    }
</div>

@code {
    [Parameter]
    public string? UserName { get; set; }
    
    private bool isDropdownOpen = false;
    private string? userRole;
    
    protected override async Task OnInitializedAsync()
    {
        userRole = await PermissionService.GetUserRoleAsync();
    }
    
    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "U";
        
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }
    
    private void ToggleDropdown()
    {
        isDropdownOpen = !isDropdownOpen;
    }
}
